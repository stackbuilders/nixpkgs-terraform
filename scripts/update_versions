#!/usr/bin/env nix-shell
#!nix-shell -i python3 -p python3Packages.pygithub -p python3Packages.semver

# vi: ft=python

import functools
import os
import github
import json
import semver
import subprocess

def read_versions():
    with open("versions.json") as f:
        return json.load(f)

current_versions = read_versions().keys()

def is_stable(release):
    version = release.title.removeprefix("v")
    return semver.compare(version, "1.5.0") >= 0 and not (release.draft or release.prerelease)

def by_version(release):
    return release.title.removeprefix("v").split(".")

def to_version(versions, release):
    version = release.title.removeprefix("v")
    print(f"Calculating hash for {version}")
    hash_output = subprocess.check_output(["nix-prefetch-git", "--quiet", "https://github.com/hashicorp/terraform", release.title])
    vendor_hash_output = subprocess.check_output([
        "nix-prefetch",
        "--silent",
        "--option",
        "extra-experimental-features",
        "flakes",
        "--file",
        "vendor_hash.nix",
        "--argstr",
        "version",
        version
    ])
    versions[version] = {
        "hash": json.loads(hash_output.decode("utf-8"))["hash"],
        "vendorHash": vendor_hash_output.decode("utf-8")
    }
    return versions

auth = github.Auth.Token(os.environ["GITHUB_TOKEN"])
g = github.Github(auth=auth)
repo = g.get_repo("hashicorp/terraform")
releases = list(filter(is_stable, repo.get_releases()))
releases.sort(reverse=True,key=by_version)
versions = functools.reduce(to_version, releases, {})
print(versions)
